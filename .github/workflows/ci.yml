name: CICD-Databricks

on:
  pull_request:
    branches: [dev, test, prod]
  push:
    branches: [dev, test, prod]
  workflow_dispatch:
    inputs:
      maturity_override:
        description: "Override maturity checks for this run: none|warn_only|skip (only used by ci-test)"
        required: false
        default: "none"
        type: choice
        options: [none, warn_only, skip]

permissions:
  contents: read

jobs:
  ci_dev:
    if: ${{ github.ref_name == 'dev' || (github.event_name == 'pull_request' && github.base_ref == 'dev') }}
    name: ci-dev
    uses: EricAustinBarber/SUNDT_DW_CICD_PIPELINE/.github/workflows/reusable-databricks.yml@main
    with:
      mode: ci-dev
      bundle_path: databricks
      target: dev
      environment_name: DataBricks-Dev

      run_asset_validation: false
      run_post_deployment_tests: true
      post_deploy_summary_output: both
      run_post_deploy_smoke: true
      smoke_mode: notebook
      smoke_notebook_path: /Workspace/Shared/DataFlow/example/dev/sundt_example_bundle/files/resources/notebooks/smoke_tests/notebook_smoke_test
    secrets:
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
      DATABRICKS_VALIDATION_CLUSTER_ID: ${{ secrets.DATABRICKS_VALIDATION_CLUSTER_ID }}
      DATABRICKS_SQL_WAREHOUSE_ID: ${{ secrets.DATABRICKS_SQL_WAREHOUSE_ID }}

  ci_test:
    if: ${{ github.ref_name == 'test' || (github.event_name == 'pull_request' && github.base_ref == 'test') }}
    name: ci-test
    uses: EricAustinBarber/SUNDT_DW_CICD_PIPELINE/.github/workflows/reusable-databricks.yml@main
    with:
      mode: ci-test
      bundle_path: databricks
      target: test
      environment_name: DataBricks-Test

      run_post_deployment_tests: true
      post_deploy_summary_output: both

      run_post_deploy_smoke: true
      smoke_mode: notebook
      smoke_notebook_path: /Workspace/Shared/DataFlow/example/test/sundt_example_bundle/files/resources/notebooks/smoke_tests/notebook_smoke_test

      run_asset_validation: true
      asset_validation_notebook_path: /Workspace/Shared/DataFlow/example/test/sundt_example_bundle/files/validation_driver/validation_driver_notebook

      # Maturity telemetry + warn-only checks in test
      run_maturity_collect: true
      run_maturity_ci_check: true
      maturity_enforcement_mode: warn
      maturity_override: ${{ github.event.inputs.maturity_override || 'none' }}
      bundle_name: sundt_example_bundle

      promote_artifact_only: false
    secrets:
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
      DATABRICKS_VALIDATION_CLUSTER_ID: ${{ secrets.DATABRICKS_VALIDATION_CLUSTER_ID }}
      DATABRICKS_SQL_WAREHOUSE_ID: ${{ secrets.DATABRICKS_SQL_WAREHOUSE_ID }}

  cd_prod:
    if: ${{ github.event_name == 'push' && github.ref_name == 'prod' }}
    name: cd-prod
    uses: EricAustinBarber/SUNDT_DW_CICD_PIPELINE/.github/workflows/reusable-databricks.yml@main
    with:
      mode: cd-prod
      bundle_path: databricks
      target: prod
      environment_name: DataBricks-Prod

      run_asset_validation: false
      run_post_deployment_tests: true
      post_deploy_summary_output: both

      run_post_deploy_smoke: true
      smoke_mode: notebook
      smoke_notebook_path: /Workspace/Shared/DataFlow/example/prod/sundt_example_bundle/files/resources/notebooks/smoke_tests/notebook_smoke_test

      # Prod: deploy + metrics tracking only (no gate check)
      run_maturity_collect: true
      run_maturity_ci_check: false
      maturity_enforcement_mode: off
      maturity_override: none
      bundle_name: sundt_example_bundle

      promote_artifact_only: false
    secrets:
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
      DATABRICKS_VALIDATION_CLUSTER_ID: ${{ secrets.DATABRICKS_VALIDATION_CLUSTER_ID }}
      DATABRICKS_SQL_WAREHOUSE_ID: ${{ secrets.DATABRICKS_SQL_WAREHOUSE_ID }}
