# ci.yml
name: CICD-Databricks

on:
  pull_request:
    branches: [dev, test, prod]
  push:
    branches: [dev, test, prod]
  workflow_dispatch:
    inputs:
      maturity_override:
        description: "Override maturity checks for this run: none|warn_only|skip (only used by ci-test)"
        required: false
        default: "none"
        type: choice
        options: [none, warn_only, skip]

permissions:
  contents: read

concurrency:
  group: cicd-databricks-${{ github.ref }}
  cancel-in-progress: true

jobs:
  unit_tests:
    name: unit-tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest
      - name: Run tests
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: pytest -q

  ci_dev:
    # Run when:
    # - pushing directly to dev
    # - creating/updating a PR with base branch = dev
    if: ${{ github.ref_name == 'dev' || (github.event_name == 'pull_request' && github.base_ref == 'dev') }}
    name: ci-dev
    needs: [unit_tests]
    uses: EricAustinBarber/sundt-edm-cicd-platform/.github/workflows/reusable-databricks.yml@81cdf941de0fae03687fe5cc7bba08c3501dd183
    with:
      mode: ci-dev
      bundle_path: databricks
      target: dev
      environment_name: DataBricks-Dev

      # Dev: validate + deploy + post-deploy verification + smoke
      run_post_deployment_tests: true
      post_deploy_summary_output: both
      run_post_deploy_smoke: true
      smoke_mode: bundle-run
      smoke_job_key: smoke
    secrets:
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
      DATABRICKS_SQL_WAREHOUSE_ID: ${{ secrets.DATABRICKS_SQL_WAREHOUSE_ID }}

  ci_test:
    # Run when:
    # - pushing directly to test
    # - creating/updating a PR with base branch = test
    if: ${{ github.ref_name == 'test' || (github.event_name == 'pull_request' && (github.base_ref == 'test' || github.base_ref == 'prod')) }}
    name: ci-test
    needs: [unit_tests]
    uses: EricAustinBarber/sundt-edm-cicd-platform/.github/workflows/reusable-databricks.yml@81cdf941de0fae03687fe5cc7bba08c3501dd183
    with:
      mode: ci-test
      bundle_path: databricks
      target: test
      environment_name: DataBricks-Test

      # Test: validate + deploy + post-deploy verification + smoke + metadata-driven asset validation
      run_post_deployment_tests: true
      post_deploy_summary_output: both

      # Smoke should be part of the bundle (recommended) and invoked via bundle run:
      run_post_deploy_smoke: true
      smoke_mode: bundle-run
      smoke_job_key: smoke

      # Maturity telemetry + warn-only gate in test.
      run_post_deploy_bundle_jobs: true
      post_deploy_bundle_jobs_json: |
        [
          {
            "job_key": "maturity_collect",
            "params": {
              "env": "test",
              "run_id": "${{ github.run_id }}",
              "commit_sha": "${{ github.sha }}",
              "repo": "${{ github.repository }}",
              "git_ref": "${{ github.ref }}",
              "workflow_run_id": "${{ github.run_id }}",
              "bundle_name": "sundt_example_bundle"
            }
          },
          {
            "job_key": "maturity_ci_check",
            "params": {
              "env": "test",
              "enforcement_mode": "warn",
              "maturity_override": "${{ github.event.inputs.maturity_override || 'none' }}"
            }
          },
          {
            "job_key": "maturity_scorecard_status_load",
            "params": {
              "env": "test",
              "updated_by": "bundle"
            }
          },
          {
            "job_key": "maturity_scorecard_eval",
            "params": {
              "env": "test",
              "run_id": "${{ github.run_id }}",
              "commit_sha": "${{ github.sha }}"
            }
          },
          {
            "job_key": "maturity_scorecard_evidence_stub",
            "params": {
              "env": "test",
              "write_mode": "dry_run",
              "updated_by": "evidence_stub"
            }
          }
        ]

      promote_artifact_only: false
    secrets:
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
      DATABRICKS_SQL_WAREHOUSE_ID: ${{ secrets.DATABRICKS_SQL_WAREHOUSE_ID }}

  cd_prod:
    # Only run on direct pushes to prod (no PRs). This makes prod a "merge target" from test.
    if: ${{ github.event_name == 'push' && github.ref_name == 'prod' }}
    name: cd-prod
    needs: [unit_tests]
    uses: EricAustinBarber/sundt-edm-cicd-platform/.github/workflows/reusable-databricks.yml@81cdf941de0fae03687fe5cc7bba08c3501dd183
    with:
      mode: cd-prod
      bundle_path: databricks
      target: prod
      environment_name: DataBricks-Prod

      # Prod: deploy + post-deploy verification + smoke
      run_post_deployment_tests: true
      post_deploy_summary_output: both

      run_post_deploy_smoke: true
      smoke_mode: bundle-run
      smoke_job_key: smoke

      # For now, let prod also build+deploy for demo purposes.
      # Later, when you have a proper release promotion, set this to true and deploy only
      # previously-built artifacts.
      promote_artifact_only: false
    secrets:
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
      DATABRICKS_SQL_WAREHOUSE_ID: ${{ secrets.DATABRICKS_SQL_WAREHOUSE_ID }}
